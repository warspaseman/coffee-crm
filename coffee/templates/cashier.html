<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Smart POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .menu-item { cursor: pointer; transition: 0.2s; height: 100%; border: none; }
        .menu-item:hover { transform: translateY(-5px); }
        .receipt-area { height: 100vh; background: #f8f9fa; border-left: 1px solid #dee2e6; }
        .category-btn.active { background-color: #0d6efd; color: white; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 p-4">
            <div class="d-flex gap-2 mb-4 overflow-auto pb-2">
                <button class="btn btn-outline-primary category-btn rounded-pill px-4" onclick="filter('coffee', this)">–ö–æ—Ñ–µ</button>
                <button class="btn btn-outline-primary category-btn rounded-pill px-4" onclick="filter('dessert', this)">–î–µ—Å–µ—Ä—Ç—ã</button>
            </div>

            <div class="row g-3">
                {% for item in items %}
                <div class="col-md-3 col-6 item-card" data-category="{{ item.category }}">
                    <div class="card menu-item shadow-sm" onclick="checkAndAddToCart({{ item.id }}, '{{ item.name }}', {{ item.price }}, '{{ item.category }}')">
                        {% if item.image %}
                            <img src="{{ item.image.url }}" class="card-img-top" style="height: 120px; object-fit: cover;">
                        {% else %}
                            <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 120px;">‚òï</div>
                        {% endif %}
                        <div class="card-body text-center p-2">
                            <h6 class="card-title mb-1">{{ item.name }}</h6>
                            <small class="text-primary fw-bold">{{ item.price }} ‚Ç∏</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-4 receipt-area p-4 d-flex flex-column shadow">
            <h4 class="mb-4">üßæ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h4>
            <div id="cart-items" class="flex-grow-1 overflow-auto mb-3 pe-2">
                </div>
            <div class="mt-auto bg-white p-3 rounded shadow-sm">
                <div class="d-flex justify-content-between h4 mb-3">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span id="total-price" class="text-primary">0 ‚Ç∏</span>
                </div>
                <button onclick="submitOrder()" class="btn btn-success w-100 btn-lg py-3">–û–ø–ª–∞—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="optionsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>–†–∞–∑–º–µ—Ä:</h6>
                <div class="btn-group w-100 mb-3" role="group">
                    <input type="radio" class="btn-check" name="size" id="sizeS" value="S" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="sizeS">S (-20%)</label>

                    <input type="radio" class="btn-check" name="size" id="sizeM" value="M" checked autocomplete="off">
                    <label class="btn btn-outline-secondary" for="sizeM">M (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</label>

                    <input type="radio" class="btn-check" name="size" id="sizeL" value="L" autocomplete="off">
                    <label class="btn btn-outline-secondary" for="sizeL">L (+25%)</label>
                </div>

                <h6>–î–æ–±–∞–≤–∫–∏:</h6>
                <div class="modifiers-container" style="max-height: 300px; overflow-y: auto;">
                    
                    {% regroup modifiers by get_category_display as modifier_list %}

                    {% for group in modifier_list %}
                        <h6 class="text-muted mt-2 border-bottom pb-1">{{ group.grouper }}</h6>
                        
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% for mod in group.list %}
                            <input type="checkbox" class="btn-check mod-check" 
                                id="mod{{ mod.id }}" 
                                value="{{ mod.id }}" 
                                data-price="{{ mod.price }}" 
                                data-name="{{ mod.name }}">
                            
                            <label class="btn btn-outline-warning text-dark btn-sm" for="mod{{ mod.id }}">
                                {{ mod.name }} <br> <small class="text-secondary">+{{ mod.price }}‚Ç∏</small>
                            </label>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="confirmAddToCart()">–î–æ–±–∞–≤–∏—Ç—å –≤ —á–µ–∫</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cart = [];
    let currentItem = {};
    let modal;

    window.onload = () => { modal = new bootstrap.Modal(document.getElementById('optionsModal')); }

    function checkAndAddToCart(id, name, price, category) {
        if (category === 'coffee') {
            // –ï—Å–ª–∏ –∫–æ—Ñ–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ä–∞–∑–º–µ—Ä, —Å–∏—Ä–æ–ø—ã)
            openModal(id, name, price);
        } else {
            // –ï—Å–ª–∏ –¥–µ—Å–µ—Ä—Ç - —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º 1 —à—Ç
            addSimpleItemToCart(id, name, price);
        }
    }
    function openModal(id, name, price) {
        currentItem = { id, name, price };
        document.getElementById('modalTitle').innerText = name;
        document.getElementById('sizeM').checked = true;
        document.querySelectorAll('.mod-check').forEach(el => el.checked = false);
        modal.show();
    }
    function addSimpleItemToCart(id, name, price) {
        cart.push({
            id: id,
            name: name,
            size: 'M',        // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ "–°—Ç–∞–Ω–¥–∞—Ä—Ç" (–∫–æ—ç—Ñ—Ñ 1.0)
            sizeLabel: '1 —à—Ç', // –ö—Ä–∞—Å–∏–≤–∞—è –Ω–∞–¥–ø–∏—Å—å –≤ —á–µ–∫–µ
            modifiers: [],
            modifiersLabels: [],
            price: price,
            qty: 1
        });
        renderCart();
    }
    function confirmAddToCart() {
        // –ß–∏—Ç–∞–µ–º —Ä–∞–∑–º–µ—Ä
        let size = document.querySelector('input[name="size"]:checked').value;
        let sizeLabel = size === 'S' ? '–ú–∞–ª–µ–Ω—å–∫–∏–π' : (size === 'L' ? '–ë–æ–ª—å—à–æ–π' : '–°—Ä–µ–¥–Ω–∏–π');
        
        // –ß–∏—Ç–∞–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
        let mods = [];
        let modsNames = [];
        let modsPrice = 0;
        document.querySelectorAll('.mod-check:checked').forEach(el => {
            mods.push(parseInt(el.value));
            modsNames.push(el.dataset.name);
            modsPrice += parseFloat(el.dataset.price);
        });

        // –°—á–∏—Ç–∞–µ–º —Ü–µ–Ω—É –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
        let sizeMult = size === 'S' ? 0.8 : (size === 'L' ? 1.25 : 1.0);
        let finalItemPrice = (currentItem.price * sizeMult) + modsPrice;

        cart.push({
            id: currentItem.id,
            name: currentItem.name,
            size: size,
            sizeLabel: sizeLabel,
            modifiers: mods,
            modifiersLabels: modsNames,
            price: Math.round(finalItemPrice),
            qty: 1
        });

        renderCart();
        modal.hide();
    }

    function renderCart() {
        let container = document.getElementById('cart-items');
        container.innerHTML = '';
        let total = 0;

        cart.forEach((item, index) => {
            total += item.price;
            let modsHtml = item.modifiersLabels.length ? `<br><small class="text-warning">+ ${item.modifiersLabels.join(', ')}</small>` : '';
            
            container.innerHTML += `
                <div class="card mb-2 border-0 shadow-sm">
                    <div class="card-body p-2 d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item.name}</strong> <span class="badge bg-secondary">${item.size}</span>
                            ${modsHtml}
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">${item.price} ‚Ç∏</div>
                            <button onclick="removeFromCart(${index})" class="btn btn-sm btn-link text-danger p-0">—É–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
        });
        document.getElementById('total-price').innerText = total + " ‚Ç∏";
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function submitOrder() {
        if (!cart.length) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
        
        fetch('/cashier/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ items: cart })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                cart = [];
                renderCart();
            } else {
                alert(data.message);
            }
        });
    }

    function filter(cat, btn) {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.item-card').forEach(card => {
            card.style.display = (cat === 'all' || card.dataset.category === cat) ? 'block' : 'none';
        });
    }
</script>
</body>
</html>