{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KDS - –ö—É—Ö–Ω—è</title>
    <style>
        body { margin: 0; padding: 20px; background: #000000; font-family: system-ui, sans-serif; color: white; }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ü–û–¢–û–ö–ê –ó–ê–ö–ê–ó–û–í */
        .orders-stream {
            display: flex;
            flex-wrap: wrap; /* –ü–ª–∏—Ç–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É */
            gap: 15px;
            align-items: flex-start;
        }

        /* –ö–ê–†–¢–û–ß–ö–ê –ó–ê–ö–ê–ó–ê */
        .ticket {
            background: #fff;
            color: #111;
            width: 280px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 6px solid #9CA3AF; /* –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (pending) */
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* –ó–ê–ì–û–õ–û–í–û–ö –ö–ê–†–¢–û–ß–ö–ò */
        .ticket-header {
            background: #F3F4F6; padding: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #E5E7EB;
        }
        .ticket-id { font-weight: 900; font-size: 20px; }
        .ticket-time { font-size: 14px; color: #6B7280; font-weight: 600; }

        /* –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í */
        .ticket-body { padding: 15px; flex-grow: 1; min-height: 100px; }
        .ticket-item { font-size: 15px; font-weight: 600; margin-bottom: 8px; line-height: 1.4; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .ticket-item span { font-weight: 400; color: #555; font-size: 13px; }

        /* –§–£–¢–ï–† –° –ö–ù–û–ü–ö–û–ô */
        .ticket-footer { padding: 10px; background: #fff; border-top: 1px solid #f0f0f0; }
        .action-btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            transition: 0.2s; text-transform: uppercase;
        }
        
        /* === –°–¢–ê–¢–£–°–´ === */
        
        /* 1. –ù–û–í–´–ô (PENDING) */
        .status-pending { border-left-color: #FCD34D; } /* –ñ–µ–ª—Ç–∞—è –ø–æ–ª–æ—Å–∫–∞ */
        .btn-start { background: #FCD34D; color: #1F2937; }
        .btn-start:hover { background: #F59E0B; }

        /* 2. –ì–û–¢–û–í–ò–¢–°–Ø (PREPARING) */
        .status-preparing { border-left-color: #3B82F6; } /* –°–∏–Ω—è—è –ø–æ–ª–æ—Å–∫–∞ */
        .timer-badge { display: block; text-align: center; font-size: 24px; font-weight: 800; margin-bottom: 10px; color: #3B82F6; font-variant-numeric: tabular-nums; }
        .btn-ready { background: #3B82F6; color: white; }
        .btn-ready:hover { background: #2563EB; }

        /* 3. –ì–û–¢–û–í (READY) */
        .status-ready { border-left-color: #10B981; background: #ECFDF5; } /* –ó–µ–ª–µ–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ */
        .status-ready .ticket-header { background: #D1FAE5; }
        .status-ready .ticket-body { background: #ECFDF5; }
        .status-ready .ticket-footer { background: #ECFDF5; }
        
        .ready-message { text-align: center; color: #059669; font-weight: 800; font-size: 18px; margin-bottom: 10px; }
        .btn-serve { background: #10B981; color: white; }
        .btn-serve:hover { background: #059669; }

        /* –ü–£–°–¢–û–ô –≠–ö–†–ê–ù */
        .no-orders { width: 100%; text-align: center; color: #6B7280; margin-top: 100px; font-size: 20px; }

    </style>
</head>
<body>

    <div class="orders-stream" id="kitchen-container">
        </div>
    <script>
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        setInterval(fetchOrders, 2000);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫–∞–Ω—å–µ —Ç–∞–π–º–µ—Ä–æ–≤ –∫–∞–∂–¥—É—é 1 —Å–µ–∫—É–Ω–¥—É (–¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)
        setInterval(updateTimers, 1000);
        
        fetchOrders();

        function fetchOrders() {
            fetch('/api/orders/')
                .then(res => res.json())
                .then(data => {
                    syncTickets(data.orders);
                })
                .catch(err => console.error("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏:", err));
        }

        // –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (–í–º–µ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏)
        function syncTickets(orders) {
            const container = document.getElementById('kitchen-container');
            const serverIds = new Set(orders.map(o => o.id));

            // 1. –£–î–ê–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Completed)
            document.querySelectorAll('.ticket').forEach(card => {
                const cardId = parseInt(card.dataset.id);
                if (!serverIds.has(cardId)) {
                    card.remove(); // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                }
            });

            // 2. –î–û–ë–ê–í–õ–ï–ù–ò–ï –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï
            orders.forEach(order => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º completed (–æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å)
                if (order.status === 'completed') return;

                let card = document.querySelector(`.ticket[data-id="${order.id}"]`);

                // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –ù–ï–¢ ‚Äî —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
                if (!card) {
                    card = document.createElement('div');
                    card.className = `ticket status-${order.status}`;
                    card.dataset.id = order.id;
                    card.dataset.createdAt = order.created_at; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏
                    card.innerHTML = generateCardHTML(order);
                    container.appendChild(card); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                } 
                else {
                    // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –ï–°–¢–¨ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å
                    if (card.dataset.status !== order.status) {
                        card.className = `ticket status-${order.status}`;
                        card.dataset.status = order.status;
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (–∫–Ω–æ–ø–∫–∏ –ø–æ–º–µ–Ω—è–ª–∏—Å—å)
                        card.innerHTML = generateCardHTML(order);
                    }
                }
            });

            if (orders.length === 0 && container.children.length === 0) {
                container.innerHTML = '<div class="no-orders">u r free now</div>';
            } else {
                const emptyMsg = container.querySelector('.no-orders');
                if (emptyMsg) emptyMsg.remove();
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –∫–∞—Ä—Ç–æ—á–∫–∏ (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥)
        function generateCardHTML(order) {
            const createdDate = new Date(order.created_at);
            const timeStr = createdDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
            
            // –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã (–ø–∞—Ä—Å–∏–º HTML –∏–∑ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å span)
            const itemsHtml = order.item_name.split(',').map(i => `<div class="ticket-item">${i.trim()}</div>`).join('');

            let footerHtml = '';
            let extraBodyHtml = '';

            if (order.status === 'pending') {
                footerHtml = `<button class="action-btn btn-start" onclick="updateStatus(${order.id}, 'preparing')">Start</button>`;
            } 
            else if (order.status === 'preparing') {
                // –¢–∞–π–º–µ—Ä –≤—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π, —Ñ—É–Ω–∫—Ü–∏—è updateTimers –µ–≥–æ –∑–∞–ø–æ–ª–Ω–∏—Ç —á–µ—Ä–µ–∑ 1–º—Å
                extraBodyHtml = `<div class="timer-badge" id="timer-${order.id}">00:00</div>`;
                footerHtml = `<button class="action-btn btn-ready" onclick="updateStatus(${order.id}, 'ready')">Ready</button>`;
            } 
            else if (order.status === 'ready') {
                extraBodyHtml = `<div class="ready-message">Call the customer! üì¢</div>`;
                footerHtml = `<button class="action-btn btn-serve" onclick="updateStatus(${order.id}, 'completed')">Served </button>`;
            }

            return `
                <div class="ticket-header">
                    <span class="ticket-id">#${order.id}</span>
                    <span class="ticket-time">${timeStr}</span>
                </div>
                <div class="ticket-body">
                    ${extraBodyHtml}
                    ${itemsHtml}
                </div>
                <div class="ticket-footer">
                    ${footerHtml}
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –¢–ê–ô–ú–ï–†–ê (—Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ –º–∏–≥–∞–µ—Ç)
        function updateTimers() {
            document.querySelectorAll('.ticket[data-status="preparing"]').forEach(card => {
                const createdDate = new Date(card.dataset.createdAt);
                const timerElement = card.querySelector('.timer-badge');
                
                if (timerElement) {
                    const diffMs = new Date() - createdDate;
                    const mm = Math.floor(diffMs / 60000).toString().padStart(2, '0');
                    const ss = Math.floor((diffMs % 60000) / 1000).toString().padStart(2, '0');
                    timerElement.innerText = `${mm}:${ss}`;
                }
            });
        }

        function updateStatus(id, newStatus) {
            fetch(`/api/order/${id}/update/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) fetchOrders(); // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
            });
        }
    </script>
</body>
</html>